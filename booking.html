<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="">
    <title>Car Maintenance Service - Book Appointment</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.bunny.net">
    <link href="https://fonts.bunny.net/css?family=inter:400,500,600,700,800" rel="stylesheet" />
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    
    <!-- Alpine.js for navigation dropdown -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <style>
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
        }
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .service-card.selected {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .time-slot.selected {
            background-color: #1f2937;
            border-color: #1f2937;
            color: white;
        }
        .loading i {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="font-sans antialiased bg-gradient-to-br from-slate-50 via-white to-slate-100 min-h-screen">
    <div class="min-h-screen">
        <!-- Navigation -->
        <nav x-data="{ mobileOpen: false }" class="bg-white/80 backdrop-blur-md border-b border-slate-200/50 shadow-sm sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16 items-center">
                    <div class="flex items-center">
                        <!-- Logo -->
                        <div class="shrink-0 flex items-center">
                            <a href="index.html" class="flex items-center group">
                                <div class="bg-gradient-to-br from-indigo-600 to-purple-600 rounded-xl p-2 mr-3 group-hover:scale-110 transition-transform">
                                    <i class="fas fa-car text-white text-xl"></i>
                                </div>
                                <span class="text-xl font-bold">Car Maintenance</span>
                            </a>
                        </div>
                        
                        <!-- Navigation Links -->
                        <div class="hidden space-x-2 sm:-my-px sm:ms-10 sm:flex">
                            <a href="index.html" class="inline-flex items-center px-1 pt-1 border-b-2 border-transparent text-sm font-medium leading-5 text-gray-500 hover:text-gray-700 hover:border-gray-300 focus:outline-none focus:text-gray-700 focus:border-gray-300 transition">
                                <i class="fas fa-tachometer-alt mr-2"></i> Dashboard
                            </a>
                            <a href="vehicles.html" class="inline-flex items-center px-1 pt-1 border-b-2 border-transparent text-sm font-medium leading-5 text-gray-500 hover:text-gray-700 hover:border-gray-300 focus:outline-none focus:text-gray-700 focus:border-gray-300 transition">
                                <i class="fas fa-car mr-2"></i> My Vehicles
                            </a>
                            <a href="appointments.html" class="inline-flex items-center px-1 pt-1 border-b-2 border-transparent text-sm font-medium leading-5 text-gray-500 hover:text-gray-700 hover:border-gray-300 focus:outline-none focus:text-gray-700 focus:border-gray-300 transition">
                                <i class="fas fa-calendar mr-2"></i> Appointments
                            </a>
                            <a href="booking.html" class="inline-flex items-center px-1 pt-1 border-b-2 border-indigo-500 text-sm font-medium leading-5 text-gray-900 focus:outline-none focus:border-indigo-700 transition">
                                <i class="fas fa-calendar-plus mr-2"></i> Book Appointment
                            </a>
                        </div>
                    </div>

                    <div class="flex items-center gap-2">
                        <button type="button" class="sm:hidden inline-flex items-center justify-center p-2 rounded-lg text-slate-700 hover:bg-white/60 focus:outline-none" @click="mobileOpen = !mobileOpen" aria-label="Toggle menu">
                            <i class="fas" :class="mobileOpen ? 'fa-times' : 'fa-bars'"></i>
                        </button>

                        <div class="hidden sm:flex sm:items-center sm:ms-6">
                            <div class="relative" x-data="{ open: false }">
                                <button @click="open = !open" class="inline-flex items-center px-4 py-2 border border-transparent text-sm leading-4 font-medium rounded-lg text-slate-700 bg-white/50 hover:bg-white hover:text-slate-900 focus:outline-none transition ease-in-out duration-150 shadow-sm hover:shadow-md">
                                    <div class="flex items-center">
                                        <div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-full flex items-center justify-center mr-2">
                                            <i class="fas fa-user text-white text-sm"></i>
                                        </div>
                                        <span id="user-name">User</span>
                                    </div>
                                    <div class="ms-2">
                                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                        </svg>
                                    </div>
                                </button>
                                <div x-show="open" @click.away="open = false" x-transition class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg py-1 z-50">
                                    <a href="profile.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                        <i class="fas fa-user-edit mr-2"></i> Profile
                                    </a>
                                    <a href="#" onclick="Logout.logout()" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                        <i class="fas fa-sign-out-alt mr-2"></i> Log Out
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sm:hidden" x-show="mobileOpen" x-transition>
                <div class="pt-2 pb-3 space-y-1">
                    <a href="index.html" class="block px-3 py-2 rounded-lg text-base font-medium text-slate-700 hover:bg-white/60">
                        <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
                    </a>
                    <a href="vehicles.html" class="block px-3 py-2 rounded-lg text-base font-medium text-slate-700 hover:bg-white/60">
                        <i class="fas fa-car mr-2"></i>My Vehicles
                    </a>
                    <a href="appointments.html" class="block px-3 py-2 rounded-lg text-base font-medium text-slate-700 hover:bg-white/60">
                        <i class="fas fa-calendar mr-2"></i>Appointments
                    </a>
                    <a href="booking.html" class="block px-3 py-2 rounded-lg text-base font-medium text-slate-700 hover:bg-white/60">
                        <i class="fas fa-calendar-plus mr-2"></i>Book Appointment
                    </a>
                </div>

                <div class="pt-2 pb-3 border-t border-slate-200/60">
                    <a href="profile.html" class="block px-3 py-2 rounded-lg text-base font-medium text-slate-700 hover:bg-white/60">
                        <i class="fas fa-user-edit mr-2"></i>Profile
                    </a>
                    <a href="#" onclick="Logout.logout()" class="block px-3 py-2 rounded-lg text-base font-medium text-slate-700 hover:bg-white/60">
                        <i class="fas fa-sign-out-alt mr-2"></i>Log Out
                    </a>
                </div>
            </div>
        </nav>

        <!-- Flash Messages / Alert Container -->
        <div id="alert-container" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-4"></div>

        <!-- Page Heading -->
        <header class="bg-white/80 backdrop-blur-md shadow-sm border-b border-slate-200">
            <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center">
                    <h2 class="font-semibold text-xl text-gray-800 leading-tight">
                        <i class="fas fa-calendar-plus mr-2"></i>Book Appointment
                    </h2>
                    <div id="config" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-sm">
                        <label class="block font-semibold mb-1">API URL:</label>
                        <input type="text" id="api-url" value="https://laravel-test-system.orbit-node.com/api" 
                            class="w-full px-2 py-1 border border-gray-300 rounded text-xs">
                    </div>
                </div>
            </div>
        </header>

        <!-- Page Content -->
        <main class="py-8">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="py-6">
                    <div class="max-w-4xl mx-auto">
                        <div class="bg-white rounded-lg shadow p-6">
                            <form id="appointment-form">
                                
                                <!-- Customer Information Section -->
                                <div class="mb-6">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Customer Information
                                    </label>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label for="customer_name" class="block text-sm font-medium text-gray-700 mb-2">
                                                Full Name <span class="text-red-500">*</span>
                                            </label>
                                            <input type="text" id="customer_name" name="customer_name" required
                                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div>
                                            <label for="customer_email" class="block text-sm font-medium text-gray-700 mb-2">
                                                Email <span class="text-red-500">*</span>
                                            </label>
                                            <input type="email" id="customer_email" name="customer_email" required
                                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                    </div>
                                    <div>
                                        <label for="customer_phone" class="block text-sm font-medium text-gray-700 mb-2">
                                            Phone Number
                                        </label>
                                        <input type="tel" id="customer_phone" name="customer_phone"
                                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>

                                <!-- Vehicle Information Section -->
                                <div class="mb-6">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Vehicle Information
                                    </label>
                                    <div id="vehicle-selector-wrapper" class="hidden mb-4">
                                        <label for="vehicle_selector" class="block text-sm font-medium text-gray-700 mb-2">
                                            Select Registered Vehicle
                                        </label>
                                        <select id="vehicle_selector" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">Manual entry</option>
                                        </select>
                                        <p id="vehicle-selector-hint" class="mt-2 text-sm text-gray-500"></p>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label for="vehicle_make" class="block text-sm font-medium text-gray-700 mb-2">
                                                Make <span class="text-red-500">*</span>
                                            </label>
                                            <input type="text" id="vehicle_make" name="vehicle_make" required
                                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div>
                                            <label for="vehicle_model" class="block text-sm font-medium text-gray-700 mb-2">
                                                Model <span class="text-red-500">*</span>
                                            </label>
                                            <input type="text" id="vehicle_model" name="vehicle_model" required
                                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label for="vehicle_year" class="block text-sm font-medium text-gray-700 mb-2">
                                                Year <span class="text-red-500">*</span>
                                            </label>
                                            <input type="number" id="vehicle_year" name="vehicle_year" min="1900" max="2025" required
                                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div>
                                            <label for="vehicle_license_plate" class="block text-sm font-medium text-gray-700 mb-2">
                                                License Plate <span class="text-red-500">*</span>
                                            </label>
                                            <input type="text" id="vehicle_license_plate" name="vehicle_license_plate" required
                                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label for="vehicle_vin" class="block text-sm font-medium text-gray-700 mb-2">
                                                VIN (Optional)
                                            </label>
                                            <input type="text" id="vehicle_vin" name="vehicle_vin" maxlength="17"
                                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div>
                                            <label for="vehicle_color" class="block text-sm font-medium text-gray-700 mb-2">
                                                Color
                                            </label>
                                            <input type="text" id="vehicle_color" name="vehicle_color"
                                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <label for="vehicle_mileage" class="block text-sm font-medium text-gray-700 mb-2">
                                            Mileage
                                        </label>
                                        <input type="number" id="vehicle_mileage" name="vehicle_mileage" min="0"
                                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>

                                <!-- Service Selection Section -->
                                <div class="mb-6">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Select Services <span class="text-red-500">*</span>
                                    </label>
                                    <div id="services-loading" class="text-center py-4 text-blue-600">
                                        <i class="fas fa-spinner fa-spin mr-2"></i>Loading services...
                                    </div>
                                    <div id="services-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                                </div>

                                <!-- Date & Time Selection Section -->
                                <div class="mb-6">
                                    <label for="appointment_date" class="block text-sm font-medium text-gray-700 mb-2">
                                        Appointment Date & Time <span class="text-red-500">*</span>
                                    </label>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <input type="date" id="appointment_date" name="appointment_date" required
                                                min="" 
                                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Available Time Slots</label>
                                            <div id="time-slots-container">
                                                <p class="text-sm text-gray-500">Select a date and services first</p>
                                            </div>
                                        </div>
                                    </div>
                                    <p class="mt-2 text-sm text-gray-500">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        Shop hours: 8:00 AM - 6:00 PM
                                    </p>
                                </div>

                                <!-- Notes Section -->
                                <div class="mb-6">
                                    <label for="notes" class="block text-sm font-medium text-gray-700 mb-2">
                                        Additional Notes (Optional)
                                    </label>
                                    <textarea id="notes" name="notes" rows="4"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        placeholder="Any special instructions or concerns..."></textarea>
                                </div>

                                <!-- Total Price Display -->
                                <div class="mb-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <div class="flex justify-between items-center">
                                        <span class="text-lg font-semibold text-gray-700">Estimated Total:</span>
                                        <span class="text-2xl font-bold text-blue-600" id="total-price">$0.00</span>
                                    </div>
                                    <p class="text-sm text-gray-600 mt-1" id="estimated-duration">Duration: 0 minutes</p>
                                </div>

                                <!-- Submit Buttons -->
                                <div class="flex justify-end space-x-4">
                                    <button type="button" onclick="resetForm()" class="px-6 py-2 border-2 border-black bg-transparent hover:bg-black text-black hover:text-white rounded-lg transition font-medium">
                                        Cancel
                                    </button>
                                    <button type="submit" id="submit-btn" class="px-6 py-2 border-2 border-black bg-transparent hover:bg-black text-black hover:text-white rounded-lg transition font-semibold">
                                        <i class="fas fa-calendar-check mr-2"></i>Book Appointment
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Global variables
        let services = [];
        let selectedServices = [];
        let selectedDate = null;
        let selectedTimeSlot = null;
        let availableSlots = [];
        let bookedSlots = []; // Track slots that are already booked
        let myVehicles = [];

        // Configuration: API Base URL
        function getApiUrl() {
            const url = document.getElementById('api-url').value.trim();
            return url.endsWith('/') ? url.slice(0, -1) : url;
        }

        function getAuthToken() {
            return localStorage.getItem('authToken') || '';
        }

        function setupNavAuth() {
            if (!getAuthToken()) return;

            $('nav a[href="login.html"]').hide();
            $('nav a[href="register.html"]').hide();

            $('nav .nav-actions').each(function () {
                const navActions = $(this);
                if (navActions.find('.nav-profile-link').length > 0) {
                    return;
                }

                navActions.append(`
                    <a href="profile.html" class="nav-profile-link border-2 border-black bg-transparent hover:bg-black text-black hover:text-white px-4 py-2 rounded-lg transition font-semibold">
                        <i class="fas fa-user mr-2"></i>Profile
                    </a>
                    <a href="#" class="nav-logout-link border-2 border-black bg-transparent hover:bg-black text-black hover:text-white px-4 py-2 rounded-lg transition font-semibold">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </a>
                `);

                navActions.find('.nav-logout-link').last().on('click', function (e) {
                    e.preventDefault();
                    logout();
                });
            });
        }

        function logout() {
            $.ajax({
                url: `${getApiUrl()}/auth/logout`,
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`,
                },
                complete: function() {
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('currentUser');
                    window.location.href = 'login.html';
                }
            });
        }

        // Initialize on page load
        $(document).ready(function() {
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            $('#appointment_date').attr('min', today);
            if (getAuthToken()) {
                // Booking now requires login; keep the fields but prevent edits to reduce confusion.
                try {
                    const rawUser = localStorage.getItem('currentUser');
                    const currentUser = rawUser ? JSON.parse(rawUser) : null;
                    if (currentUser) {
                        $('#customer_name').val(((currentUser.name || '') + ' ' + (currentUser.last_name || '')).trim() || (currentUser.name || ''));
                        $('#customer_email').val(currentUser.email || '');
                    }
                } catch (e) {}
                $('#customer_name').prop('disabled', true);
                $('#customer_email').prop('disabled', true);
            }

            setupNavAuth();
            
            // Set username in dropdown
            var currentUser = null;
            try {
                const rawUser = localStorage.getItem('currentUser');
                currentUser = rawUser ? JSON.parse(rawUser) : null;
            } catch (e) {}
            
            if (currentUser && $('#user-name').length) {
                $('#user-name').text(currentUser.username || currentUser.name || 'User');
            }
            
            loadServices();
            loadMyVehicles();
            setupEventListeners();
        });

        // Setup event listeners
        function setupEventListeners() {
            $('#appointment_date').on('change', function() {
                selectedDate = $(this).val();
                selectedTimeSlot = null;
                if (selectedDate && selectedServices.length > 0) {
                    loadAvailableSlots();
                }
            });

            $('#vehicle_selector').on('change', function() {
                const selectedId = $(this).val();
                applySelectedVehicle(selectedId);
            });

            $('#appointment-form').on('submit', handleFormSubmit);
        }

        function loadMyVehicles() {
            const token = getAuthToken();
            if (!token) {
                return;
            }

            const apiUrl = getApiUrl();

            $.ajax({
                url: `${apiUrl}/me/vehicles`,
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Authorization': `Bearer ${token}`,
                },
                success: function(res) {
                    myVehicles = (res && res.data && res.data.vehicles) ? res.data.vehicles : [];
                    renderVehicleSelector();
                },
                error: function(xhr) {
                    if (xhr && xhr.status === 401) {
                        localStorage.removeItem('authToken');
                        localStorage.removeItem('currentUser');
                    }
                }
            });
        }

        function renderVehicleSelector() {
            const wrapper = $('#vehicle-selector-wrapper');
            const select = $('#vehicle_selector');
            const hint = $('#vehicle-selector-hint');

            if (!myVehicles || myVehicles.length === 0) {
                wrapper.removeClass('hidden');
                select.html('<option value="">Manual entry</option>');
                hint.text('No registered vehicles found. You can add one in “My Vehicles” and come back.');
                applySelectedVehicle('');
                return;
            }

            wrapper.removeClass('hidden');
            hint.text('Choose a vehicle to auto-fill details, or select “Manual entry”.');

            const options = ['<option value="">Manual entry</option>'];
            myVehicles.forEach(function(v) {
                const id = (v && (v.id !== undefined && v.id !== null)) ? String(v.id) : '';
                const label = `${v.year || ''} ${v.make || ''} ${v.model || ''} (${v.license_plate || 'N/A'})`.trim();
                if (id) {
                    options.push(`<option value="${id}">${label}</option>`);
                }
            });
            select.html(options.join(''));
        }

        function applySelectedVehicle(vehicleId) {
            const fields = ['#vehicle_make', '#vehicle_model', '#vehicle_year', '#vehicle_license_plate', '#vehicle_vin', '#vehicle_color', '#vehicle_mileage'];

            if (!vehicleId) {
                fields.forEach(function(sel) {
                    $(sel).prop('readonly', false);
                });
                return;
            }

            const v = (myVehicles || []).find(function(item) {
                return item && String(item.id) === String(vehicleId);
            });

            if (!v) {
                fields.forEach(function(sel) {
                    $(sel).prop('readonly', false);
                });
                return;
            }

            $('#vehicle_make').val(v.make || '');
            $('#vehicle_model').val(v.model || '');
            $('#vehicle_year').val(v.year || '');
            $('#vehicle_license_plate').val(v.license_plate || '');
            $('#vehicle_vin').val(v.vin || '');
            $('#vehicle_color').val(v.color || '');
            $('#vehicle_mileage').val((v.mileage !== undefined && v.mileage !== null) ? v.mileage : '');

            fields.forEach(function(sel) {
                $(sel).prop('readonly', true);
            });
        }

        // Load services from API
        function loadServices() {
            const apiUrl = getApiUrl();
            
            $.ajax({
                url: `${apiUrl}/public/services`,
                method: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (response.success && response.data) {
                        services = response.data;
                        renderServices();
                        $('#services-loading').addClass('hidden');
                    } else {
                        showAlert('error', 'Failed to load services. Please try again.');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading services:', error);
                    showAlert('error', 'Failed to connect to the server. Please check your API URL configuration.');
                    $('#services-loading').html('<p class="text-red-600">Error loading services. Please check API URL.</p>');
                }
            });
        }

        // Render services
        function renderServices() {
            const container = $('#services-container');
            container.empty();

            if (services.length === 0) {
                container.html('<p class="text-gray-600">No services available at this time.</p>');
                return;
            }

            services.forEach(service => {
                const card = $(`
                    <div class="border rounded-lg p-4 hover:bg-gray-50 transition service-card" data-service-id="${service.id}">
                        <label class="flex items-start cursor-pointer">
                            <input type="checkbox" value="${service.id}" class="mt-1 mr-3 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-semibold text-gray-900">${service.name}</p>
                                        ${service.description ? `<p class="text-sm text-gray-600 mt-1">${service.description}</p>` : ''}
                                    </div>
                                    <div class="text-right ml-4">
                                        <p class="font-semibold text-blue-600">$${parseFloat(service.price).toFixed(2)}</p>
                                        <p class="text-xs text-gray-500">${service.duration_minutes} min</p>
                                    </div>
                                </div>
                            </div>
                        </label>
                    </div>
                `);

                card.find('input[type="checkbox"]').on('change', function() {
                    toggleService(service.id, $(this).is(':checked'));
                    card.toggleClass('selected', $(this).is(':checked'));
                    updateSummary();
                    if (selectedDate) {
                        loadAvailableSlots();
                    }
                });

                container.append(card);
            });
        }

        // Toggle service selection
        function toggleService(serviceId, isSelected) {
            if (isSelected) {
                if (!selectedServices.find(s => s.id === serviceId)) {
                    selectedServices.push(services.find(s => s.id === serviceId));
                }
            } else {
                selectedServices = selectedServices.filter(s => s.id !== serviceId);
            }
        }

        // Load available time slots
        function loadAvailableSlots() {
            if (!selectedDate || selectedServices.length === 0) {
                return;
            }

            const apiUrl = getApiUrl();
            const serviceIds = selectedServices.map(s => s.id);

            $('#time-slots-container').html('<div class="text-center py-2 text-blue-600"><i class="fas fa-spinner fa-spin mr-2"></i>Loading available slots...</div>');

            // Reset booked slots
            bookedSlots = [];

            // First, load available slots from API
            $.ajax({
                url: `${apiUrl}/public/available-slots`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    date: selectedDate,
                    service_ids: serviceIds
                }),
                success: function(response) {
                    if (response.success && response.data) {
                        availableSlots = response.data.slots || [];
                        // Then load existing appointments to check for booked slots
                        loadBookedAppointments();
                    } else {
                        $('#time-slots-container').html('<p class="text-sm text-red-600">No available slots for this date.</p>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading slots:', error);
                    let errorMsg = 'Failed to load available time slots.';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg = xhr.responseJSON.message;
                    }
                    $('#time-slots-container').html(`<p class="text-sm text-red-600">${errorMsg}</p>`);
                }
            });
        }

        // Load existing appointments for the selected date to identify booked slots
        function loadBookedAppointments() {
            const apiUrl = getApiUrl();
            const token = getAuthToken();

            // If user is logged in, check their appointments
            if (token) {
                $.ajax({
                    url: `${apiUrl}/me/appointments`,
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                    success: function(response) {
                        if (response.success && response.data && response.data.appointments) {
                            const appointments = response.data.appointments;
                            const selectedDateStr = selectedDate; // Format: YYYY-MM-DD
                            
                            // Filter appointments for the selected date
                            appointments.forEach(function(apt) {
                                if (!apt.appointment_date) return;
                                
                                const aptDate = new Date(apt.appointment_date);
                                const selectedDateObj = new Date(selectedDateStr);
                                
                                // Check if appointment is on the selected date
                                if (aptDate.toISOString().split('T')[0] === selectedDateObj.toISOString().split('T')[0]) {
                                    // Extract time from appointment_date
                                    const aptTime = aptDate.toTimeString().substring(0, 5); // HH:mm format
                                    bookedSlots.push(aptTime);
                                    
                                    // Also check if appointment has an end_time and mark that range as booked
                                    if (apt.end_time) {
                                        const endTime = new Date(apt.end_time);
                                        const endTimeStr = endTime.toTimeString().substring(0, 5);
                                        // Mark all 30-minute slots between start and end as booked
                                        markTimeRangeAsBooked(aptTime, endTimeStr);
                                    }
                                }
                            });
                        }
                        
                        // Also check all appointments (admin endpoint) if possible
                        // For now, we'll rely on the user's appointments and the API's availability check
                        renderTimeSlots();
                    },
                    error: function(xhr) {
                        // If we can't load user appointments, still render slots
                        // The API should have already filtered unavailable slots
                        console.warn('Could not load user appointments:', xhr);
                        renderTimeSlots();
                    }
                });
            } else {
                // If not logged in, just render the slots returned by the API
                // The API should have already filtered unavailable slots
                renderTimeSlots();
            }
        }

        // Mark a time range as booked (for appointments that span multiple slots)
        function markTimeRangeAsBooked(startTime, endTime) {
            const start = parseTime(startTime);
            const end = parseTime(endTime);
            
            if (!start || !end) return;
            
            let current = new Date(start);
            while (current < end) {
                const timeStr = current.toTimeString().substring(0, 5);
                if (bookedSlots.indexOf(timeStr) === -1) {
                    bookedSlots.push(timeStr);
                }
                // Move to next 30-minute slot
                current.setMinutes(current.getMinutes() + 30);
            }
        }

        // Parse time string (HH:mm) to Date object
        function parseTime(timeStr) {
            if (!timeStr || typeof timeStr !== 'string') return null;
            const parts = timeStr.split(':');
            if (parts.length < 2) return null;
            
            const date = new Date();
            date.setHours(parseInt(parts[0], 10));
            date.setMinutes(parseInt(parts[1], 10));
            date.setSeconds(0);
            date.setMilliseconds(0);
            return date;
        }

        // Check if a slot is booked
        function isSlotBooked(slotDatetime) {
            if (!slotDatetime) return false;
            
            // Extract time from slot datetime
            let timeStr = '';
            if (slotDatetime.includes('T')) {
                timeStr = slotDatetime.split('T')[1].substring(0, 5);
            } else if (slotDatetime.includes(' ')) {
                timeStr = slotDatetime.split(' ')[1].substring(0, 5);
            } else {
                timeStr = slotDatetime.substring(0, 5);
            }
            
            return bookedSlots.indexOf(timeStr) !== -1;
        }

        // Render time slots
        function renderTimeSlots() {
            const container = $('#time-slots-container');
            container.empty();

            if (availableSlots.length === 0) {
                container.html('<p class="text-sm text-red-600">No available time slots for the selected date and services.</p>');
                return;
            }

            const slotsGrid = $('<div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2"></div>');

            availableSlots.forEach(slot => {
                const slotDatetime = slot.datetime || slot.time;
                let timeStr = '';
                if (slotDatetime.includes('T')) {
                    timeStr = slotDatetime.split('T')[1].substring(0, 5);
                } else if (slotDatetime.includes(' ')) {
                    timeStr = slotDatetime.split(' ')[1].substring(0, 5);
                } else {
                    timeStr = slotDatetime.substring(0, 5);
                }
                
                // Check if this slot is already booked
                const isBooked = isSlotBooked(slotDatetime);
                
                // Determine button classes and disabled state
                const baseClasses = 'time-slot px-3 py-2 text-sm border-2 rounded-lg transition';
                const normalClasses = 'border-gray-300 hover:border-gray-400';
                const bookedClasses = 'border-gray-200 bg-gray-100 text-gray-400 cursor-not-allowed opacity-50';
                const classes = isBooked ? `${baseClasses} ${bookedClasses}` : `${baseClasses} ${normalClasses}`;
                
                const slotBtn = $(`
                    <button type="button" class="${classes}" data-time="${slotDatetime}" ${isBooked ? 'disabled title="This time slot is already booked"' : ''}>
                        ${timeStr}${isBooked ? ' <i class="fas fa-lock text-xs"></i>' : ''}
                    </button>
                `);

                if (!isBooked) {
                    slotBtn.on('click', function() {
                        $('.time-slot').removeClass('selected');
                        $(this).addClass('selected');
                        selectedTimeSlot = $(this).data('time');
                    });
                } else {
                    slotBtn.css('pointer-events', 'none');
                }

                slotsGrid.append(slotBtn);
            });

            container.append(slotsGrid);
            
            // Show message if there are booked slots
            if (bookedSlots.length > 0) {
                container.append('<p class="mt-2 text-xs text-gray-500"><i class="fas fa-info-circle mr-1"></i>Locked slots are already booked</p>');
            }
        }

        // Update summary
        function updateSummary() {
            let total = 0;
            let totalDuration = 0;

            selectedServices.forEach(service => {
                total += parseFloat(service.price);
                totalDuration += parseInt(service.duration_minutes);
            });

            $('#total-price').text(`$${total.toFixed(2)}`);
            $('#estimated-duration').text(`Duration: ${totalDuration} minutes`);
        }

        // Handle form submit
        function handleFormSubmit(e) {
            e.preventDefault();

            const token = getAuthToken();
            if (!token) {
                showAlert('error', 'Please login to book an appointment.');
                setTimeout(function () {
                    window.location.href = 'login.html';
                }, 500);
                return;
            }

            if (selectedServices.length === 0) {
                showAlert('error', 'Please select at least one service.');
                return;
            }

            if (!selectedDate) {
                showAlert('error', 'Please select an appointment date.');
                return;
            }

            if (!selectedTimeSlot) {
                showAlert('error', 'Please select an available time slot.');
                return;
            }

            const formData = {
                vehicle_make: $('#vehicle_make').val(),
                vehicle_model: $('#vehicle_model').val(),
                vehicle_year: parseInt($('#vehicle_year').val()),
                vehicle_license_plate: $('#vehicle_license_plate').val(),
                vehicle_vin: $('#vehicle_vin').val() || null,
                vehicle_color: $('#vehicle_color').val() || null,
                vehicle_mileage: $('#vehicle_mileage').val() ? parseInt($('#vehicle_mileage').val()) : null,
                appointment_date: selectedTimeSlot,
                service_ids: selectedServices.map(s => s.id),
                notes: $('#notes').val() || null
            };

            submitAppointment(formData);
        }

        // Submit appointment
        function submitAppointment(data) {
            const apiUrl = getApiUrl();
            const submitBtn = $('#submit-btn');
            const token = getAuthToken();

            submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-2"></i>Booking...');

            $.ajax({
                url: `${apiUrl}/me/appointments`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                headers: {
                    'Accept': 'application/json',
                    'Authorization': `Bearer ${token}`,
                },
                success: function(response) {
                    if (response.success) {
                        showAlert('success', `Appointment booked successfully! Job Order #: ${response.data.job_order_number || response.data.appointment_id}`);
                        resetForm();
                    } else {
                        showAlert('error', response.message || 'Failed to book appointment.');
                        submitBtn.prop('disabled', false).html('<i class="fas fa-calendar-check mr-2"></i>Book Appointment');
                    }
                },
                error: function(xhr, status, error) {
                    let errorMsg = 'Failed to book appointment. Please try again.';
                    if (xhr.responseJSON) {
                        if (xhr.responseJSON.message) {
                            errorMsg = xhr.responseJSON.message;
                        }
                        if (xhr.responseJSON.errors) {
                            const errors = Object.values(xhr.responseJSON.errors).flat();
                            errorMsg = errors.join('<br>');
                        }
                    }
                    showAlert('error', errorMsg);
                    submitBtn.prop('disabled', false).html('<i class="fas fa-calendar-check mr-2"></i>Book Appointment');
                }
            });
        }

        // Show alert message
        function showAlert(type, message) {
            const alertClass = type === 'success' 
                ? 'bg-green-50 border-l-4 border-green-500 text-green-700' 
                : 'bg-red-50 border-l-4 border-red-500 text-red-700';
            
            const icon = type === 'success' 
                ? '<i class="fas fa-check-circle mr-3 text-xl"></i>' 
                : '<i class="fas fa-exclamation-circle mr-3 text-xl"></i>';
            
            const alertHtml = `
                <div class="${alertClass} p-4 rounded-lg shadow-md animate-fade-in-up" role="alert">
                    <div class="flex items-center">
                        ${icon}
                        <div class="flex-1">
                            <p class="font-semibold">${message}</p>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" class="ml-auto ${type === 'success' ? 'text-green-700 hover:text-green-900' : 'text-red-700 hover:text-red-900'}">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
            $('#alert-container').stop(true, true).show().html(alertHtml);
            
            // Auto-hide after 5 seconds for success messages
            if (type === 'success') {
                setTimeout(() => {
                    $('#alert-container').fadeOut();
                }, 5000);
            }

            // Scroll to top to show alert
            $('html, body').animate({ scrollTop: 0 }, 300);
        }

        // Reset form
        function resetForm() {
            $('#appointment-form')[0].reset();
            selectedServices = [];
            selectedDate = null;
            selectedTimeSlot = null;
            availableSlots = [];
            bookedSlots = [];
            $('.service-card').removeClass('selected');
            $('.service-card input[type="checkbox"]').prop('checked', false);
            $('#time-slots-container').html('<p class="text-sm text-gray-500">Select a date and services first</p>');
            updateSummary();
        }
    </script>
</body>
</html>
