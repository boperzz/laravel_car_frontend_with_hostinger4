<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="">
    <title>Car Maintenance Service - My Appointments</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.bunny.net">
    <link href="https://fonts.bunny.net/css?family=inter:400,500,600,700,800" rel="stylesheet" />
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

    <script src="js/api.js"></script>
    <script src="js/date-utils.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/role-guard.js"></script>
    <script src="js/logout.js"></script>
    
    <!-- Alpine.js for navigation dropdown -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <style>
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
        }
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
    </style>
</head>
<body class="font-sans antialiased bg-gradient-to-br from-slate-50 via-white to-slate-100 min-h-screen">
    <div class="min-h-screen">
        <!-- Navigation -->
        <nav x-data="{ mobileOpen: false }" class="bg-white/80 backdrop-blur-md border-b border-slate-200/50 shadow-sm sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16 items-center">
                    <div class="flex items-center">
                        <!-- Logo -->
                        <div class="shrink-0 flex items-center">
                            <a href="index.html" class="flex items-center group">
                                <div class="bg-gradient-to-br from-indigo-600 to-purple-600 rounded-xl p-2 mr-3 group-hover:scale-110 transition-transform">
                                    <i class="fas fa-car text-white text-xl"></i>
                                </div>
                                <span class="text-xl font-bold">Car Maintenance</span>
                            </a>
                        </div>
                        
                        <!-- Navigation Links -->
                        <div class="hidden space-x-2 sm:-my-px sm:ms-10 sm:flex">
                            <a href="index.html" class="inline-flex items-center px-1 pt-1 border-b-2 border-transparent text-sm font-medium leading-5 text-gray-500 hover:text-gray-700 hover:border-gray-300 focus:outline-none focus:text-gray-700 focus:border-gray-300 transition">
                                <i class="fas fa-tachometer-alt mr-2"></i> Dashboard
                            </a>
                            <a href="vehicles.html" class="inline-flex items-center px-1 pt-1 border-b-2 border-transparent text-sm font-medium leading-5 text-gray-500 hover:text-gray-700 hover:border-gray-300 focus:outline-none focus:text-gray-700 focus:border-gray-300 transition">
                                <i class="fas fa-car mr-2"></i> My Vehicles
                            </a>
                            <a href="appointments.html" class="inline-flex items-center px-1 pt-1 border-b-2 border-indigo-500 text-sm font-medium leading-5 text-gray-900 focus:outline-none focus:border-indigo-700 transition">
                                <i class="fas fa-calendar mr-2"></i> Appointments
                            </a>
                        </div>
                    </div>

                    <div class="flex items-center gap-2">
                        <button type="button" class="sm:hidden inline-flex items-center justify-center p-2 rounded-lg text-slate-700 hover:bg-white/60 focus:outline-none" @click="mobileOpen = !mobileOpen" aria-label="Toggle menu">
                            <i class="fas" :class="mobileOpen ? 'fa-times' : 'fa-bars'"></i>
                        </button>

                        <div class="hidden sm:flex sm:items-center sm:ms-6">
                            <div class="relative" x-data="{ open: false }">
                                <button @click="open = !open" class="inline-flex items-center px-4 py-2 border border-transparent text-sm leading-4 font-medium rounded-lg text-slate-700 bg-white/50 hover:bg-white hover:text-slate-900 focus:outline-none transition ease-in-out duration-150 shadow-sm hover:shadow-md">
                                    <div class="flex items-center">
                                        <div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-full flex items-center justify-center mr-2">
                                            <i class="fas fa-user text-white text-sm"></i>
                                        </div>
                                        <span id="user-name">User</span>
                                    </div>
                                    <div class="ms-2">
                                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                        </svg>
                                    </div>
                                </button>
                                <div x-show="open" @click.away="open = false" x-transition class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg py-1 z-50">
                                    <a href="booking.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                        <i class="fas fa-calendar-plus mr-2"></i> Book Appointment
                                    </a>
                                    <a href="profile.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                        <i class="fas fa-user-edit mr-2"></i> Profile
                                    </a>
                                    <a href="login.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                        <i class="fas fa-sign-in-alt mr-2"></i> Login
                                    </a>
                                    <a href="register.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                        <i class="fas fa-user-plus mr-2"></i> Register
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            <div class="sm:hidden" x-show="mobileOpen" x-transition>
                <div class="pt-2 pb-3 space-y-1">
                    <a href="index.html" class="block px-3 py-2 rounded-lg text-base font-medium text-slate-700 hover:bg-white/60">
                        <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
                    </a>
                    <a href="vehicles.html" class="block px-3 py-2 rounded-lg text-base font-medium text-slate-700 hover:bg-white/60">
                        <i class="fas fa-car mr-2"></i>My Vehicles
                    </a>
                    <a href="appointments.html" class="block px-3 py-2 rounded-lg text-base font-medium text-slate-700 hover:bg-white/60">
                        <i class="fas fa-calendar mr-2"></i>Appointments
                    </a>
                    <a href="booking.html" class="block px-3 py-2 rounded-lg text-base font-medium text-slate-700 hover:bg-white/60">
                        <i class="fas fa-calendar-plus mr-2"></i>Book Appointment
                    </a>
                </div>

                <div class="pt-2 pb-3 border-t border-slate-200/60">
                    <a href="profile.html" class="block px-3 py-2 rounded-lg text-base font-medium text-slate-700 hover:bg-white/60">
                        <i class="fas fa-user-edit mr-2"></i>Profile
                    </a>
                    <a href="login.html" class="block px-3 py-2 rounded-lg text-base font-medium text-slate-700 hover:bg-white/60">
                        <i class="fas fa-sign-in-alt mr-2"></i>Login
                    </a>
                    <a href="register.html" class="block px-3 py-2 rounded-lg text-base font-medium text-slate-700 hover:bg-white/60">
                        <i class="fas fa-user-plus mr-2"></i>Register
                    </a>
                </div>
            </div>
            </div>
        </nav>

        <!-- Flash Messages / Alert Container -->
        <div id="alert-container" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-4"></div>

        <!-- Page Heading -->
        <header class="bg-white/80 backdrop-blur-md shadow-sm border-b border-slate-200">
            <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center">
                    <h2 class="font-semibold text-xl text-gray-800 leading-tight">
                        <i class="fas fa-calendar mr-2"></i>My Appointments
                    </h2>
                    <a href="index.html" class="border-2 border-black bg-transparent hover:bg-black text-black hover:text-white px-4 py-2 rounded-lg transition font-semibold">
                        <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
                    </a>
                </div>
            </div>
        </header>

        <!-- Page Content -->
        <main class="py-8">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="py-6">
                    <div id="appointments-loading" class="text-center py-8 text-blue-600">
                        <i class="fas fa-spinner fa-spin mr-2"></i>Loading appointments...
                    </div>
                    
                    <div id="appointments-container" class="hidden">
                        <!-- Appointments table will be inserted here -->
                    </div>
                    
                    <div id="appointments-empty" class="hidden bg-white rounded-lg shadow p-12 text-center">
                        <i class="fas fa-calendar-times text-6xl text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">No Appointments Yet</h3>
                        <p class="text-gray-500 mb-6">Book your first appointment to get started.</p>
                        <a href="booking.html" class="inline-block border-2 border-black bg-transparent hover:bg-black text-black hover:text-white px-6 py-3 rounded-lg transition font-semibold">
                            <i class="fas fa-calendar-plus mr-2"></i>Book Appointment
                        </a>
                    </div>
                </div>
            </div>
        </main>

        <div id="edit-appointment-modal" class="hidden fixed inset-0 z-50">
            <div class="absolute inset-0 bg-black/50"></div>
            <div class="relative min-h-full flex items-center justify-center p-4">
                <div class="w-full max-w-2xl bg-white rounded-lg shadow-xl overflow-hidden">
                    <div class="px-6 py-4 border-b border-slate-200 flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-900">
                            <i class="fas fa-edit mr-2"></i>Edit Appointment
                        </h3>
                        <button type="button" id="edit-appointment-close" class="text-gray-500 hover:text-gray-800">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <form id="edit-appointment-form" class="px-6 py-5">
                        <div class="mb-5">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Services <span class="text-red-500">*</span></label>
                            <div id="edit-services-loading" class="text-center py-3 text-blue-600">
                                <i class="fas fa-spinner fa-spin mr-2"></i>Loading services...
                            </div>
                            <div id="edit-services-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                        </div>

                        <div class="mb-5">
                            <label for="edit-appointment-date" class="block text-sm font-medium text-gray-700 mb-2">Appointment Date & Time <span class="text-red-500">*</span></label>
                            <input type="datetime-local" id="edit-appointment-date" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <p class="mt-2 text-sm text-gray-500">
                                <i class="fas fa-info-circle mr-1"></i>
                                You can only edit pending appointments.
                            </p>
                        </div>

                        <div class="mb-5">
                            <label for="edit-notes" class="block text-sm font-medium text-gray-700 mb-2">Notes (Optional)</label>
                            <textarea id="edit-notes" rows="4"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Any special instructions or concerns..."></textarea>
                        </div>

                        <div class="mb-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex justify-between items-center">
                                <span class="text-lg font-semibold text-gray-700">Estimated Total:</span>
                                <span class="text-2xl font-bold text-blue-600" id="edit-total-price">$0.00</span>
                            </div>
                            <p class="text-sm text-gray-600 mt-1" id="edit-estimated-duration">Duration: 0 minutes</p>
                        </div>

                        <div class="flex justify-end space-x-3">
                            <button type="button" id="edit-appointment-cancel" class="px-6 py-2 border-2 border-black bg-transparent hover:bg-black text-black hover:text-white rounded-lg transition font-medium">
                                Cancel
                            </button>
                            <button type="submit" id="edit-appointment-save" class="px-6 py-2 border-2 border-black bg-transparent hover:bg-black text-black hover:text-white rounded-lg transition font-semibold">
                                <i class="fas fa-save mr-2"></i>Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration: API Base URL
        function getApiUrl() {
            return (window.Api && Api.getBaseUrl) ? Api.getBaseUrl() : 'https://laravel-test-system.orbit-node.com/api';
        }

        function getAuthToken() {
            return localStorage.getItem('authToken') || '';
        }

        function setupNavAuth() {
            if (!getAuthToken()) return;

            $('nav a[href="login.html"]').hide();
            $('nav a[href="register.html"]').hide();

            const navActions = $('nav div.flex.items-center.space-x-3').first();
            if (navActions.length && navActions.find('#profile-link').length === 0) {
                navActions.append(`
                    <a href="profile.html" id="profile-link" class="border-2 border-black bg-transparent hover:bg-black text-black hover:text-white px-4 py-2 rounded-lg transition font-semibold">
                        <i class="fas fa-user mr-2"></i>Profile
                    </a>
                    <a href="#" id="logout-link" class="border-2 border-black bg-transparent hover:bg-black text-black hover:text-white px-4 py-2 rounded-lg transition font-semibold">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </a>
                `);

                $('#logout-link').on('click', function(e) {
                    e.preventDefault();
                    logout();
                });
            }
        }

        function logout() {
            if (window.Logout && Logout.logout) {
                Logout.logout();
                return;
            }

            $.ajax({
                url: `${getApiUrl()}/auth/logout`,
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`,
                },
                complete: function() {
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('currentUser');
                    window.location.href = 'login.html';
                }
            });
        }

        // Load appointments on page load
        $(document).ready(function() {
            if (!getAuthToken()) {
                window.location.href = 'login.html';
                return;
            }

            // Customer portal pages: allow admin, block staff
            if (!RoleGuard.canAccess(['customer'])) {
                Auth.redirectToDashboard(Auth.getRole());
                return;
            }

            setupNavAuth();

            loadAppointments();
        });

        let allAppointments = [];
        let currentSearch = '';
        let currentStatusFilter = 'all';
        let searchDebounceTimer = null;

        function loadAppointments() {
            $('#appointments-loading').show();
            $('#appointments-empty').addClass('hidden');
            $('#appointments-container').addClass('hidden').html('');

            $.ajax({
                url: `${getApiUrl()}/me/appointments`,
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`,
                },
                success: function(res) {
                    const appointments = res && res.data && res.data.appointments ? res.data.appointments : [];

                    $('#appointments-loading').hide();

                    if (!appointments.length) {
                        allAppointments = [];
                        $('#appointments-empty').removeClass('hidden');
                        return;
                    }

                    $('#appointments-container').removeClass('hidden');
                    allAppointments = appointments;
                    applyAppointmentFilters();
                },
                error: function(xhr) {
                    $('#appointments-loading').hide();

                    if (xhr && xhr.status === 401) {
                        localStorage.removeItem('authToken');
                        localStorage.removeItem('currentUser');
                        window.location.href = 'login.html';
                        return;
                    }

                    $('#appointments-empty').removeClass('hidden');
                    showAlert('error', 'Failed to load appointments.');
                }
            });
        }

        function applyAppointmentFilters() {
            const q = String(currentSearch || '').trim().toLowerCase();
            const status = String(currentStatusFilter || 'all').toLowerCase();

            let list = Array.isArray(allAppointments) ? allAppointments.slice() : [];

            if (status !== 'all') {
                list = list.filter(function(a) {
                    return String(a && a.status ? a.status : '').toLowerCase() === status;
                });
            }

            if (q) {
                list = list.filter(function(a) {
                    const vehicle = a && a.vehicle ? `${a.vehicle.make || ''} ${a.vehicle.model || ''} ${a.vehicle.year || ''} ${a.vehicle.license_plate || ''}` : '';
                    const services = (a && a.services && a.services.length)
                        ? a.services.map(function(s) { return s && s.name ? s.name : ''; }).join(' ')
                        : '';
                    const staff = a && a.staff ? (a.staff.name || a.staff.username || '') : '';
                    const date = a && a.appointment_date ? String(a.appointment_date) : '';
                    const statusText = a && a.status ? String(a.status) : '';
                    const haystack = `${vehicle} ${services} ${staff} ${date} ${statusText}`.toLowerCase();
                    return haystack.indexOf(q) !== -1;
                });
            }

            list.sort(function(a, b) {
                const da = a && a.appointment_date ? Date.parse(a.appointment_date) : 0;
                const db = b && b.appointment_date ? Date.parse(b.appointment_date) : 0;
                return (db || 0) - (da || 0);
            });

            renderAppointments(list);
        }

        function initAppointmentFiltersUI() {
            $('#appointments-search').off('input').on('input', function() {
                const val = $(this).val();
                if (searchDebounceTimer) {
                    clearTimeout(searchDebounceTimer);
                }
                searchDebounceTimer = setTimeout(function() {
                    currentSearch = val;
                    applyAppointmentFilters();
                }, 250);
            });

            $('#appointments-status-filter').off('change').on('change', function() {
                currentStatusFilter = $(this).val();
                applyAppointmentFilters();
            });

            $('#appointments-clear-filters').off('click').on('click', function() {
                currentSearch = '';
                currentStatusFilter = 'all';
                $('#appointments-search').val('');
                $('#appointments-status-filter').val('all');
                applyAppointmentFilters();
            });

            $('#appointments-search').val(currentSearch);
            $('#appointments-status-filter').val(currentStatusFilter);
        }

        function renderAppointments(appointments) {
            const hasResults = appointments && appointments.length;

            let html = `
                <div class="mb-4 bg-white rounded-lg shadow p-4">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                        <div class="flex-1">
                            <label class="block text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">Search</label>
                            <div class="relative">
                                <input id="appointments-search" type="text" placeholder="Search by vehicle, service, staff, status..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
                                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            </div>
                        </div>
                        <div class="w-full md:w-64">
                            <label class="block text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">Status</label>
                            <select id="appointments-status-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="all">All</option>
                                <option value="pending">Pending</option>
                                <option value="in_progress">In progress</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="md:self-end">
                            <button id="appointments-clear-filters" type="button" class="px-4 py-2 border-2 border-black bg-transparent hover:bg-black text-black hover:text-white rounded-lg transition font-semibold">
                                Clear
                            </button>
                        </div>
                    </div>
                </div>
            `;

            if (!hasResults) {
                html += `
                    <div class="bg-white rounded-lg shadow p-12 text-center">
                        <i class="fas fa-search text-5xl text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">No matching appointments</h3>
                        <p class="text-gray-500">Try adjusting your search or filter.</p>
                    </div>
                `;

                $('#appointments-container').html(html);
                initAppointmentFiltersUI();
                return;
            }

            html += `
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vehicle</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Services</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Staff</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
            `;

            appointments.forEach(function(a) {
                const vehicle = a.vehicle ? `${a.vehicle.make || ''} ${a.vehicle.model || ''} ${a.vehicle.year || ''}`.trim() : '—';
                const date = (window.DateUtils && DateUtils.formatDateTime) ? DateUtils.formatDateTime(a.appointment_date) : (a.appointment_date || '—');
                const services = formatServices(a.services);
                const staff = a.staff ? (a.staff.name || a.staff.username || '—') : '—';
                const status = a.status || '—';
                const total = (a.total_price !== null && a.total_price !== undefined) ? `$${parseFloat(a.total_price).toFixed(2)}` : '—';
                const encoded = encodeURIComponent(JSON.stringify(a));
                const isPending = String(a.status || '').toLowerCase() === 'pending';
                const editBtn = isPending ? `
                    <button onclick="openEditAppointment('${encoded}')" class="ml-2 border-2 border-black bg-transparent hover:bg-black text-black hover:text-white px-3 py-1 rounded transition">
                        <i class=\"fas fa-edit mr-1\"></i>Edit
                    </button>
                ` : '';
                const cancelBtn = isPending ? `
                    <button onclick="cancelAppointment('${encoded}')" class="ml-2 border-2 border-red-600 bg-transparent hover:bg-red-600 text-red-600 hover:text-white px-3 py-1 rounded transition">
                        <i class=\"fas fa-times mr-1\"></i>Cancel
                    </button>
                ` : '';

                html += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${vehicle}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${services}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${staff}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${status}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right font-semibold">${total}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm">
                            <button onclick="viewAppointmentEncoded('${encoded}')" class="border-2 border-black bg-transparent hover:bg-black text-black hover:text-white px-3 py-1 rounded transition">
                                <i class="fas fa-eye mr-1"></i>View
                            </button>
                            ${editBtn}
                            ${cancelBtn}
                        </td>
                    </tr>
                `;
            });

            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            $('#appointments-container').html(html);
            initAppointmentFiltersUI();
        }

        function formatServices(services) {
            if (!services || !services.length) return '—';
            return services.map(function(s) {
                return s.name || '—';
            }).join(', ');
        }

        function parseAppointmentEncoded(encoded) {
            try {
                return JSON.parse(decodeURIComponent(encoded));
            } catch (e) {
                return null;
            }
        }

        function viewAppointmentEncoded(encoded) {
            const a = parseAppointmentEncoded(encoded);
            if (!a) {
                showAlert('error', 'Failed to open appointment details.');
                return;
            }

            const vehicle = a.vehicle ? `${a.vehicle.make || ''} ${a.vehicle.model || ''} ${a.vehicle.year || ''}`.trim() : '—';
            const services = formatServices(a.services);
            const staff = a.staff ? (a.staff.name || a.staff.username || '—') : '—';
            const date = (window.DateUtils && DateUtils.formatDateTime) ? DateUtils.formatDateTime(a.appointment_date) : (a.appointment_date || '—');
            const status = a.status || '—';
            const total = (a.total_price !== null && a.total_price !== undefined) ? `$${parseFloat(a.total_price).toFixed(2)}` : '—';

            alert(
                `Appointment Details\n\n` +
                `Date: ${date}\n` +
                `Vehicle: ${vehicle}\n` +
                `Services: ${services}\n` +
                `Staff: ${staff}\n` +
                `Status: ${status}\n` +
                `Total: ${total}`
            );
        }

        let allServices = [];
        let editAppointment = null;
        let editSelectedServiceIds = [];

        function cancelAppointment(encoded) {
            const a = parseAppointmentEncoded(encoded);
            if (!a) {
                showAlert('error', 'Failed to cancel appointment.');
                return;
            }

            const isPending = String(a.status || '').toLowerCase() === 'pending';
            if (!isPending) {
                return;
            }

            const ok = confirm('Are you sure you want to cancel this appointment?');
            if (!ok) {
                return;
            }

            const url = `${getApiUrl()}/me/appointments/${a.id}`;

            const req = (window.Api && Api.request)
                ? Api.request({
                    url: url,
                    method: 'DELETE'
                })
                : $.ajax({
                    url: url,
                    method: 'DELETE',
                    headers: {
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`,
                    }
                });

            req.done(function(res) {
                if (res && res.success) {
                    showAlert('success', 'Appointment cancelled successfully.');
                    loadAppointments();
                    return;
                }
                showAlert('error', (res && res.message) ? res.message : 'Unable to cancel appointment.');
            }).fail(function(xhr) {
                if (xhr && xhr.status === 401) {
                    return;
                }

                let msg = 'Unable to cancel appointment. Please try again later.';
                if (xhr && xhr.responseJSON) {
                    if (xhr.responseJSON.message) {
                        msg = xhr.responseJSON.message;
                    }
                    if (xhr.responseJSON.errors) {
                        const errors = Object.values(xhr.responseJSON.errors).flat();
                        if (errors && errors.length) {
                            msg = errors.join('<br>');
                        }
                    }
                }
                showAlert('error', msg);
            });
        }

        function ensureServicesLoaded() {
            if (allServices && allServices.length) {
                return $.Deferred().resolve(allServices).promise();
            }

            $('#edit-services-loading').removeClass('hidden');
            $('#edit-services-container').html('');

            return $.ajax({
                url: `${getApiUrl()}/public/services`,
                method: 'GET',
                dataType: 'json',
                headers: {
                    'Accept': 'application/json'
                }
            }).then(function(res) {
                allServices = (res && res.success && res.data) ? res.data : [];
                return allServices;
            }).fail(function() {
                allServices = [];
                return allServices;
            }).always(function() {
                $('#edit-services-loading').addClass('hidden');
            });
        }

        function openEditAppointment(encoded) {
            const a = parseAppointmentEncoded(encoded);
            if (!a) {
                showAlert('error', 'Failed to open appointment for editing.');
                return;
            }

            const status = String(a.status || '').toLowerCase();
            if (status !== 'pending') {
                return;
            }

            editAppointment = a;
            editSelectedServiceIds = (a.services || []).map(function(s) { return s && s.id; }).filter(Boolean);

            $('#edit-notes').val(a.notes || '');

            const dtLocal = toDatetimeLocal(a.appointment_date);
            if (dtLocal) {
                $('#edit-appointment-date').val(dtLocal);
            } else {
                $('#edit-appointment-date').val('');
            }

            ensureServicesLoaded().then(function() {
                renderEditServices();
                updateEditSummary();
                showEditModal();
            });
        }

        function showEditModal() {
            $('#edit-appointment-modal').removeClass('hidden');
        }

        function hideEditModal() {
            $('#edit-appointment-modal').addClass('hidden');
            editAppointment = null;
            editSelectedServiceIds = [];
        }

        function renderEditServices() {
            const container = $('#edit-services-container');
            container.empty();

            if (!allServices || !allServices.length) {
                container.html('<p class="text-sm text-red-600">No services available.</p>');
                return;
            }

            allServices.forEach(function(service) {
                const isChecked = editSelectedServiceIds.indexOf(service.id) !== -1;
                const card = $(
                    `<div class="border rounded-lg p-4 hover:bg-gray-50 transition" data-service-id="${service.id}">
                        <label class="flex items-start cursor-pointer">
                            <input type="checkbox" value="${service.id}" class="mt-1 mr-3 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" ${isChecked ? 'checked' : ''}>
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-semibold text-gray-900">${service.name}</p>
                                        ${service.description ? `<p class="text-sm text-gray-600 mt-1">${service.description}</p>` : ''}
                                    </div>
                                    <div class="text-right ml-4">
                                        <p class="font-semibold text-blue-600">$${parseFloat(service.price).toFixed(2)}</p>
                                        <p class="text-xs text-gray-500">${service.duration_minutes} min</p>
                                    </div>
                                </div>
                            </div>
                        </label>
                    </div>`
                );

                card.find('input[type="checkbox"]').on('change', function() {
                    const id = parseInt($(this).val(), 10);
                    if ($(this).is(':checked')) {
                        if (editSelectedServiceIds.indexOf(id) === -1) {
                            editSelectedServiceIds.push(id);
                        }
                    } else {
                        editSelectedServiceIds = editSelectedServiceIds.filter(function(x) { return x !== id; });
                    }
                    updateEditSummary();
                });

                container.append(card);
            });
        }

        function updateEditSummary() {
            let total = 0;
            let duration = 0;

            (allServices || []).forEach(function(service) {
                if (editSelectedServiceIds.indexOf(service.id) === -1) {
                    return;
                }
                total += parseFloat(service.price) || 0;
                duration += parseInt(service.duration_minutes, 10) || 0;
            });

            $('#edit-total-price').text(`$${total.toFixed(2)}`);
            $('#edit-estimated-duration').text(`Duration: ${duration} minutes`);
        }

        function toDatetimeLocal(value) {
            if (!value) {
                return '';
            }

            const s = String(value);
            if (s.indexOf('T') !== -1) {
                return s.slice(0, 16);
            }

            if (s.indexOf(' ') !== -1) {
                const parts = s.split(' ');
                if (parts.length >= 2) {
                    return `${parts[0]}T${parts[1].slice(0, 5)}`;
                }
            }

            return '';
        }

        function toApiDatetime(datetimeLocal) {
            if (!datetimeLocal) {
                return '';
            }

            const s = String(datetimeLocal);
            const base = s.replace('T', ' ');
            return base.length === 16 ? `${base}:00` : base;
        }

        function validateEditForm() {
            if (!editAppointment) {
                showAlert('error', 'No appointment selected.');
                return false;
            }

            if (!editSelectedServiceIds.length) {
                showAlert('error', 'Please select at least one service.');
                return false;
            }

            const dtLocal = $('#edit-appointment-date').val();
            if (!dtLocal) {
                showAlert('error', 'Please select an appointment date and time.');
                return false;
            }

            const dateObj = new Date(dtLocal);
            if (isNaN(dateObj.getTime()) || dateObj.getTime() <= Date.now()) {
                showAlert('error', 'Appointment date must be in the future.');
                return false;
            }

            return true;
        }

        function submitEditAppointment() {
            if (!validateEditForm()) {
                return;
            }

            const btn = $('#edit-appointment-save');
            btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-2"></i>Saving...');

            const dtLocal = $('#edit-appointment-date').val();
            const payload = {
                vehicle_id: (editAppointment.vehicle && editAppointment.vehicle.id) ? editAppointment.vehicle.id : editAppointment.vehicle_id,
                appointment_date: toApiDatetime(dtLocal),
                service_ids: editSelectedServiceIds.slice(),
                notes: $('#edit-notes').val() || null
            };

            const url = `${getApiUrl()}/me/appointments/${editAppointment.id}`;

            const req = (window.Api && Api.request)
                ? Api.request({
                    url: url,
                    method: 'PUT',
                    contentType: 'application/json',
                    processData: false,
                    data: JSON.stringify(payload)
                })
                : $.ajax({
                    url: url,
                    method: 'PUT',
                    contentType: 'application/json',
                    processData: false,
                    data: JSON.stringify(payload),
                    headers: {
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`,
                    }
                });

            req.done(function(res) {
                if (res && res.success) {
                    showAlert('success', 'Appointment updated successfully.');
                    hideEditModal();
                    loadAppointments();
                    return;
                }
                showAlert('error', (res && res.message) ? res.message : 'Failed to update appointment.');
            }).fail(function(xhr) {
                if (xhr && xhr.status === 401) {
                    return;
                }

                if (xhr && xhr.status === 404) {
                    showAlert('error', 'Edit endpoint is not available on the server.');
                    return;
                }

                let msg = 'Failed to update appointment.';
                if (xhr && xhr.responseJSON) {
                    if (xhr.responseJSON.message) {
                        msg = xhr.responseJSON.message;
                    }
                    if (xhr.responseJSON.errors) {
                        const errors = Object.values(xhr.responseJSON.errors).flat();
                        if (errors && errors.length) {
                            msg = errors.join('<br>');
                        }
                    }
                }
                showAlert('error', msg);
            }).always(function() {
                btn.prop('disabled', false).html('<i class="fas fa-save mr-2"></i>Save Changes');
            });
        }

        $('#edit-appointment-close').on('click', hideEditModal);
        $('#edit-appointment-cancel').on('click', hideEditModal);
        $('#edit-appointment-form').on('submit', function(e) {
            e.preventDefault();
            submitEditAppointment();
        });

        function showAlert(type, message) {
            const alertClass = type === 'success'
                ? 'bg-green-50 border-l-4 border-green-500 text-green-700'
                : 'bg-red-50 border-l-4 border-red-500 text-red-700';
            
            const icon = type === 'success'
                ? '<i class="fas fa-check-circle mr-3 text-xl"></i>'
                : '<i class="fas fa-exclamation-circle mr-3 text-xl"></i>';
            
            const alertHtml = `
                <div class="${alertClass} p-4 rounded-lg shadow-md animate-fade-in-up" role="alert">
                    <div class="flex items-center">
                        ${icon}
                        <div class="flex-1">
                            <p class="font-semibold">${message}</p>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" class="ml-auto ${type === 'success' ? 'text-green-700 hover:text-green-900' : 'text-red-700 hover:text-red-900'}">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;

            $('#alert-container').stop(true, true).show().html(alertHtml);
        }
    </script>
</body>
</html>

